<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Water Health Index ‚Äì Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{
      --bg1:#215871;
      --bg2:#184757;
      --card:#213a4a;
      --card2:#253c4d;
      --text:#e3fbfa;
      --accent:#55ebca;
      --accent2:#39bbe9;
      --btn:#2cb5d6;
      --btn-hover:#168eaf;
      --good:#26c96a;
      --med:#f1c644;
      --poor:#e0526a;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Times New Roman",Times,serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--text);
    }
    nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:1.1rem 2.2rem 0.3rem 2.2rem;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:0.7rem;
      font-weight:bold;
      font-size:2.2rem;
    }
    .logo span{font-size:2.6rem;}
    .nav-links{
      display:flex;
      gap:2rem;
      align-items:center;
      flex-wrap:wrap;
    }
    .nav-links a{
      color:var(--text);
      text-decoration:none;
      font-weight:bold;
      padding-bottom:2px;
      border-bottom:2px solid transparent;
    }
    .nav-links a.active,
    .nav-links a:hover{
      color:var(--accent);
      border-bottom-color:var(--accent);
    }
    .langbar select{
      font-family:inherit;
      font-size:1.05rem;
      border-radius:7px;
      padding:0.32rem 0.9rem;
      border:1.3px solid #74c6e0;
      background:#15313e;
      color:var(--accent2);
      font-weight:bold;
    }
    main{
      max-width:1200px;
      margin:3vw auto 2.5vw auto;
      background:var(--card);
      border-radius:17px;
      padding:2.3rem 1.7rem 2.5rem;
      box-shadow:0 8px 28px rgba(0,0,0,0.25);
    }
    h1{
      margin:0 0 .4rem 0;
      text-align:left;
      color:var(--accent);
      font-size:2.2rem;
    }
    .intro{
      font-size:.96rem;
      color:#bfe9f4;
      margin-bottom:1.4rem;
    }
    .layout{
      display:grid;
      grid-template-columns:1.6fr 1.1fr;
      gap:1.4rem;
    }
    @media(max-width:1024px){
      .layout{grid-template-columns:1fr;}
    }
    .panel{
      background:#233845;
      border-radius:15px;
      padding:1rem 1rem 1.2rem;
    }
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:.7rem;
      align-items:center;
      margin-bottom:.6rem;
    }
    label{
      font-weight:bold;
      color:var(--accent2);
      font-size:.94rem;
    }
    select{
      padding:.35rem .7rem;
      border-radius:7px;
      border:1px solid #28526c;
      background:#182b35;
      color:#e7fbff;
      font-family:"Times New Roman",Times,serif;
      font-size:.94rem;
    }
    #mapAll{
      width:100%;
      height:430px;
      border-radius:14px;
      overflow:hidden;
    }
    .legend{
      position:absolute;
      right:1.4rem;
      bottom:1.4rem;
      background:#1b2e3aee;
      border-radius:10px;
      padding:.4rem .7rem;
      font-size:.85rem;
      color:#d5f4ff;
    }
    .legend-row{
      display:flex;
      align-items:center;
      gap:.35rem;
      margin:.08rem 0;
    }
    .dot{
      width:11px;
      height:11px;
      border-radius:50%;
    }
    .dot.good{background:var(--good);}
    .dot.med{background:var(--med);}
    .dot.poor{background:var(--poor);}
    .dot.none{background:#78909c;}
    .map-wrapper{position:relative;}

    .section-title{
      font-weight:bold;
      color:var(--accent2);
      margin-bottom:.3rem;
    }
    .details-box{
      background:#1b3241;
      border-radius:12px;
      padding:.7rem .8rem;
      font-size:.9rem;
      color:#e5fbff;
      min-height:80px;
    }
    .details-main{
      font-size:.92rem;
      margin-bottom:.25rem;
    }
    .band-badge{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:.78rem;
      color:#fff;
      margin-left:.4rem;
    }
    .band-good{background:var(--good);}
    .band-med{background:var(--med);color:#333;}
    .band-poor{background:var(--poor);}
    .band-unknown{background:#607d8b;}
    .details-sub{
      font-size:.86rem;
      color:#c4edff;
    }
    .details-sub span{
      margin-right:.5rem;
    }
    .details-note{
      margin-top:.35rem;
      font-size:.84rem;
      color:#b8e3ff;
    }
    .recent{
      margin-top:1rem;
    }
    .recent-list{
      max-height:230px;
      overflow-y:auto;
      margin-top:.2rem;
      border-radius:10px;
      background:#1b2f3b;
    }
    .recent-item{
      display:flex;
      align-items:center;
      gap:.45rem;
      padding:.42rem .55rem;
      font-size:.86rem;
      border-bottom:1px solid #213c47;
      cursor:pointer;
    }
    .recent-item:hover{
      background:#234152;
    }
    .recent-item.active{
      background:#28556a;
    }
    .recent-dot{
      width:9px;
      height:9px;
      border-radius:50%;
    }
    .recent-main{
      flex:1;
    }
    .recent-when{
      color:#d4f4ff;
    }
    .recent-index{
      font-size:.8rem;
      color:#a7d7f3;
    }
    .recent-empty{
      padding:.5rem .6rem;
      font-size:.86rem;
      color:#9ec7dc;
    }
  </style>
</head>
<body>

<nav>
  <div class="logo">
    <span aria-hidden="true">üó∫Ô∏è</span>
    Water Health Index
  </div>
  <div class="nav-links">
    <a href="index.html" id="navHome">Home</a>
    <a href="measure.html" id="navMeasure">Measure</a>
    <a href="map.html" class="active" id="navMap">Map</a>
    <a href="farmers.html" id="navFarm">Farmers Assistance</a>
    <a href="care.html" id="navCare">Care</a>
    <a href="phchart.html" id="navChart">Chart</a>
    <a href="details.html" id="navDetails">Details</a>
    <span class="langbar">
      <select id="langsel">
        <option value="en">English</option>
        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
        <option value="es">Espa√±ol</option>
        <option value="fr">Fran√ßais</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        <option value="ja">Êó•Êú¨Ë™û</option>
        <option value="zh">‰∏≠Êñá</option>
      </select>
    </span>
  </div>
</nav>

<main>
  <h1 id="pageTitle">Water quality map</h1>
  <p class="intro" id="introText">
    Explore all your saved readings on an interactive map. Tap markers to see pH, temperature and turbidity, and quickly jump to care and farming advice.
  </p>

  <div class="layout">
    <!-- LEFT: MAP -->
    <section class="panel">
      <div class="filters">
        <label for="bandFilter" id="filterLabel">Show band</label>
        <select id="bandFilter">
          <option value="all" id="filterAll">All readings</option>
          <option value="good" id="filterGood">Good (‚â• 70)</option>
          <option value="med" id="filterMed">Moderate (40‚Äì69)</option>
          <option value="poor" id="filterPoor">Poor (&lt; 40)</option>
        </select>
      </div>
      <div class="map-wrapper">
        <div id="mapAll"></div>
        <div class="legend" id="legendBox">
          <div class="legend-row"><span class="dot good"></span><span id="legGood">Good (index ‚â• 70)</span></div>
          <div class="legend-row"><span class="dot med"></span><span id="legMed">Moderate (40‚Äì69)</span></div>
          <div class="legend-row"><span class="dot poor"></span><span id="legPoor">Poor (&lt; 40)</span></div>
          <div class="legend-row"><span class="dot none"></span><span id="legNoLoc">Saved without location</span></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: DETAILS + RECENT -->
    <aside class="panel">
      <div class="section-title" id="detailsTitle">Reading details</div>
      <div class="details-box" id="detailsBox">
        <div class="details-main" id="detailsMain">
          Tap a marker on the map or pick a reading from the list to see its details here.
        </div>
        <div class="details-sub" id="detailsSub"></div>
        <div class="details-note" id="detailsNote"></div>
      </div>

      <div class="recent">
        <div class="section-title" id="recentTitle">Recent readings</div>
        <div class="recent-list" id="recentList">
          <div class="recent-empty" id="recentEmpty">
            No readings saved yet. Use the Measure page to add some, then come back here.
          </div>
        </div>
      </div>
    </aside>
  </div>
</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded',()=>{

  // -------------- translations --------------
  const strings = {
    en:{
      navHome:"Home",navMeasure:"Measure",navMap:"Map",navFarm:"Farmers Assistance",navCare:"Care",navChart:"Chart",navDetails:"Details",
      pageTitle:"Water quality map",
      intro:"Explore all your saved readings on an interactive map. Tap markers to see pH, temperature and turbidity, and quickly jump to care and farming advice.",
      filterLabel:"Show band",
      filterAll:"All readings",
      filterGood:"Good (‚â• 70)",
      filterMed:"Moderate (40‚Äì69)",
      filterPoor:"Poor (< 40)",
      legGood:"Good (index ‚â• 70)",
      legMed:"Moderate (40‚Äì69)",
      legPoor:"Poor (< 40)",
      legNoLoc:"Saved without location",
      detailsTitle:"Reading details",
      detailsEmpty:"Tap a marker on the map or pick a reading from the list to see its details here.",
      recentTitle:"Recent readings",
      recentEmpty:"No readings saved yet. Use the Measure page to add some, then come back here.",
      bandGood:"Good quality",
      bandMed:"Moderate quality",
      bandPoor:"Poor quality",
      bandUnknown:"No index",
      noLocation:"This reading has no location saved. You can still use it for care or crop advice.",
      detailsLine(when,place){
        let txt = "Saved at " + when;
        if(place) txt += " ‚Ä¢ " + place;
        return txt;
      },
      detailsSub(ph,temp,turb,index){
        return "Index " + index + " ‚Ä¢ pH " + ph + " ‚Ä¢ Temp " + temp + "¬∞C ‚Ä¢ Turbidity " + turb;
      }
    },

    hi:{
      navHome:"‡§π‡•ã‡§Æ",navMeasure:"‡§Æ‡§æ‡§™‡§®",navMap:"‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞",navFarm:"‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ",navCare:"‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤",navChart:"‡§ö‡§æ‡§∞‡•ç‡§ü",navDetails:"‡§µ‡§ø‡§µ‡§∞‡§£",
      pageTitle:"‡§ú‡§≤ ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞",
      intro:"‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§≠‡•Ä ‡§∏‡§π‡•á‡§ú‡•Ä ‡§ó‡§à ‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§á‡§∏ ‡§á‡§Ç‡§ü‡§∞‡•à‡§ï‡•ç‡§ü‡§ø‡§µ ‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞ ‡§™‡§∞ ‡§¶‡§ø‡§ñ‡§§‡•Ä ‡§π‡•à‡§Ç‡•§ ‡§Æ‡§æ‡§∞‡•ç‡§ï‡§∞ ‡§™‡§∞ ‡§ü‡•à‡§™ ‡§ï‡§∞‡§ï‡•á pH, ‡§§‡§æ‡§™‡§Æ‡§æ‡§® ‡§î‡§∞ ‡§Ö‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡§§‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§∏‡•Ä‡§ß‡•á ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§µ ‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§≤‡§æ‡§π ‡§™‡•á‡§ú ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Å‡•§",
      filterLabel:"‡§¨‡•à‡§Ç‡§° ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å",
      filterAll:"‡§∏‡§≠‡•Ä ‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó‡•ç‡§∏",
      filterGood:"‡§Ö‡§ö‡•ç‡§õ‡§æ (‚â• 70)",
      filterMed:"‡§Æ‡§ß‡•ç‡§Ø‡§Æ (40‚Äì69)",
      filterPoor:"‡§ñ‡§∞‡§æ‡§¨ (< 40)",
      legGood:"‡§Ö‡§ö‡•ç‡§õ‡§æ (‡§∏‡•Ç‡§ö‡§ï‡§æ‡§Ç‡§ï ‚â• 70)",
      legMed:"‡§Æ‡§ß‡•ç‡§Ø‡§Æ (40‚Äì69)",
      legPoor:"‡§ñ‡§∞‡§æ‡§¨ (< 40)",
      legNoLoc:"‡§∏‡•ç‡§•‡§æ‡§® ‡§¨‡§ø‡§®‡§æ ‡§∏‡§π‡•á‡§ú‡•Ä ‡§ó‡§à ‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó",
      detailsTitle:"‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§µ‡§ø‡§µ‡§∞‡§£",
      detailsEmpty:"‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞ ‡§™‡§∞ ‡§ï‡§ø‡§∏‡•Ä ‡§Æ‡§æ‡§∞‡•ç‡§ï‡§∞ ‡§™‡§∞ ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§∏‡•Ç‡§ö‡•Ä ‡§∏‡•á ‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§ö‡•Å‡§®‡•á‡§Ç, ‡§Ø‡§π‡§æ‡§Å ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è‡•§",
      recentTitle:"‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó‡•ç‡§∏",
      recentEmpty:"‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§Æ‡§æ‡§™‡§® ‡§™‡•á‡§ú ‡§∏‡•á ‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§ú‡•ã‡§°‡§º‡•á‡§Ç ‡§î‡§∞ ‡§´‡§ø‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§µ‡§æ‡§™‡§∏ ‡§Ü‡§è‡§Å‡•§",
      bandGood:"‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ",
      bandMed:"‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ",
      bandPoor:"‡§ñ‡§∞‡§æ‡§¨ ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ",
      bandUnknown:"‡§ï‡•ã‡§à ‡§∏‡•Ç‡§ö‡§ï‡§æ‡§Ç‡§ï ‡§®‡§π‡•Ä‡§Ç",
      noLocation:"‡§á‡§∏ ‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡•ç‡§•‡§æ‡§® ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ü‡§™ ‡§á‡§∏‡•á ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§Ø‡§æ ‡§´‡§∏‡§≤ ‡§∏‡§≤‡§æ‡§π ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§",
      detailsLine(when,place){
        let txt = "‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§∏‡§Æ‡§Ø: " + when;
        if(place) txt += " ‚Ä¢ " + place;
        return txt;
      },
      detailsSub(ph,temp,turb,index){
        return "‡§∏‡•Ç‡§ö‡§ï‡§æ‡§Ç‡§ï " + index + " ‚Ä¢ pH " + ph + " ‚Ä¢ ‡§§‡§æ‡§™ " + temp + "¬∞C ‚Ä¢ ‡§Ö‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡§§‡§æ " + turb;
      }
    },

    bn:{
      navHome:"‡¶π‡ßã‡¶Æ",navMeasure:"‡¶Æ‡¶æ‡¶™",navMap:"‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞",navFarm:"‡¶ï‡ßÉ‡¶∑‡¶ï ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ",navCare:"‡¶Ø‡¶§‡ßç‡¶®",navChart:"‡¶ö‡¶æ‡¶∞‡ßç‡¶ü",navDetails:"‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§",
      pageTitle:"‡¶ú‡¶≤ ‡¶Æ‡¶æ‡¶® ‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞",
      intro:"‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶¨ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶è‡¶ï ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ‡¶Ø‡¶º ‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶æ‡¶∞‡ßá ‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßá pH, ‡¶§‡¶æ‡¶™‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶ì ‡¶ò‡ßã‡¶≤‡¶æ‡¶≠‡¶æ‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶π‡¶ú‡ßá ‡¶Ø‡¶§‡ßç‡¶® ‡¶ì ‡¶ï‡ßÉ‡¶∑‡¶ï ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶™‡ßá‡¶ú‡ßá ‡¶Ø‡¶æ‡¶®‡•§",
      filterLabel:"‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®",
      filterAll:"‡¶∏‡¶¨ ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç",
      filterGood:"‡¶≠‡¶æ‡¶≤ (‚â• 70)",
      filterMed:"‡¶Æ‡¶æ‡¶ù‡¶æ‡¶∞‡¶ø (40‚Äì69)",
      filterPoor:"‡¶ñ‡¶æ‡¶∞‡¶æ‡¶™ (< 40)",
      legGood:"‡¶≠‡¶æ‡¶≤ (‡¶∏‡ßÇ‡¶ö‡¶ï ‚â• 70)",
      legMed:"‡¶Æ‡¶æ‡¶ù‡¶æ‡¶∞‡¶ø (40‚Äì69)",
      legPoor:"‡¶ñ‡¶æ‡¶∞‡¶æ‡¶™ (< 40)",
      legNoLoc:"‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶õ‡¶æ‡¶°‡¶º‡¶æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç",
      detailsTitle:"‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç‡¶Ø‡¶º‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§",
      detailsEmpty:"‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡ßá ‡¶ï‡ßã‡¶®‡¶ì ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶æ‡¶∞‡ßá ‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®, ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá‡•§",
      recentTitle:"‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç",
      recentEmpty:"‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶®‡ßá‡¶á‡•§ ‡¶Æ‡¶æ‡¶™ ‡¶™‡ßá‡¶ú ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶∏‡ßÅ‡¶®‡•§",
      bandGood:"‡¶≠‡¶æ‡¶≤ ‡¶Æ‡¶æ‡¶®‡ßá‡¶∞ ‡¶™‡¶æ‡¶®‡¶ø",
      bandMed:"‡¶Æ‡¶æ‡¶ù‡¶æ‡¶∞‡¶ø ‡¶Æ‡¶æ‡¶®‡ßá‡¶∞ ‡¶™‡¶æ‡¶®‡¶ø",
      bandPoor:"‡¶ñ‡¶æ‡¶∞‡¶æ‡¶™ ‡¶Æ‡¶æ‡¶®‡ßá‡¶∞ ‡¶™‡¶æ‡¶®‡¶ø",
      bandUnknown:"‡¶∏‡ßÇ‡¶ö‡¶ï ‡¶®‡ßá‡¶á",
      noLocation:"‡¶è‡¶á ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç‚Äë‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶®‡ßá‡¶á, ‡¶§‡¶¨‡ßÅ‡¶ì ‡¶Ø‡¶§‡ßç‡¶® ‡¶¨‡¶æ ‡¶´‡¶∏‡¶≤ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§",
      detailsLine(when,place){
        let txt = "‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º: " + when;
        if(place) txt += " ‚Ä¢ " + place;
        return txt;
      },
      detailsSub(ph,temp,turb,index){
        return "‡¶∏‡ßÇ‡¶ö‡¶ï " + index + " ‚Ä¢ pH " + ph + " ‚Ä¢ ‡¶§‡¶æ‡¶™‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ " + temp + "¬∞C ‚Ä¢ ‡¶ò‡ßã‡¶≤‡¶æ‡¶≠‡¶æ‡¶¨ " + turb;
      }
    },

    es:{
      navHome:"Inicio",navMeasure:"Medir",navMap:"Mapa",navFarm:"Ayuda a agricultores",navCare:"Cuidado",navChart:"Gr√°fico",navDetails:"Detalles",
      pageTitle:"Mapa de calidad del agua",
      intro:"Explora todas tus lecturas guardadas en un mapa interactivo. Toca los marcadores para ver pH, temperatura y turbidez, y salta r√°pido a las p√°ginas de cuidado y ayuda agr√≠cola.",
      filterLabel:"Mostrar banda",
      filterAll:"Todas las lecturas",
      filterGood:"Buena (‚â• 70)",
      filterMed:"Moderada (40‚Äì69)",
      filterPoor:"Mala (< 40)",
      legGood:"Buena (√≠ndice ‚â• 70)",
      legMed:"Moderada (40‚Äì69)",
      legPoor:"Mala (< 40)",
      legNoLoc:"Lectura sin ubicaci√≥n guardada",
      detailsTitle:"Detalles de la lectura",
      detailsEmpty:"Toca un marcador en el mapa o elige una lectura de la lista para ver sus detalles aqu√≠.",
      recentTitle:"Lecturas recientes",
      recentEmpty:"A√∫n no hay lecturas guardadas. Ve a la p√°gina Medir para a√±adir algunas y luego vuelve aqu√≠.",
      bandGood:"Calidad buena",
      bandMed:"Calidad moderada",
      bandPoor:"Calidad mala",
      bandUnknown:"Sin √≠ndice",
      noLocation:"Esta lectura no tiene ubicaci√≥n guardada, pero igual puedes usarla para consejos de cuidado y cultivos.",
      detailsLine(when,place){
        let txt = "Guardada en: " + when;
        if(place) txt += " ‚Ä¢ " + place;
        return txt;
      },
      detailsSub(ph,temp,turb,index){
        return "√çndice " + index + " ‚Ä¢ pH " + ph + " ‚Ä¢ Temp " + temp + "¬∞C ‚Ä¢ Turbidez " + turb;
      }
    },

    fr:{
      navHome:"Accueil",navMeasure:"Mesure",navMap:"Carte",navFarm:"Aide aux agriculteurs",navCare:"Soins",navChart:"Courbe",navDetails:"D√©tails",
      pageTitle:"Carte de qualit√© de l‚Äôeau",
      intro:"Affichez toutes vos mesures enregistr√©es sur une carte interactive. Touchez un marqueur pour voir le pH, la temp√©rature et la turbidit√©, puis acc√©dez rapidement aux pages de soins et d‚Äôaide aux agriculteurs.",
      filterLabel:"Afficher la bande",
      filterAll:"Toutes les mesures",
      filterGood:"Bonne (‚â• 70)",
      filterMed:"Moyenne (40‚Äì69)",
      filterPoor:"Mauvaise (< 40)",
      legGood:"Bonne (indice ‚â• 70)",
      legMed:"Moyenne (40‚Äì69)",
      legPoor:"Mauvaise (< 40)",
      legNoLoc:"Mesure sans position enregistr√©e",
      detailsTitle:"D√©tails de la mesure",
      detailsEmpty:"Touchez un marqueur sur la carte ou choisissez une mesure dans la liste pour voir les d√©tails ici.",
      recentTitle:"Mesures r√©centes",
      recentEmpty:"Aucune mesure enregistr√©e pour l‚Äôinstant. Utilisez la page Mesure puis revenez ici.",
      bandGood:"Bonne qualit√©",
      bandMed:"Qualit√© moyenne",
      bandPoor:"Mauvaise qualit√©",
      bandUnknown:"Aucun indice",
      noLocation:"Cette mesure n‚Äôa pas de position enregistr√©e, mais vous pouvez tout de m√™me l‚Äôutiliser pour les conseils de soin et de culture.",
      detailsLine(when,place){
        let txt = "Enregistr√©e le : " + when;
        if(place) txt += " ‚Ä¢ " + place;
        return txt;
      },
      detailsSub(ph,temp,turb,index){
        return "Indice " + index + " ‚Ä¢ pH " + ph + " ‚Ä¢ Temp. " + temp + "¬∞C ‚Ä¢ Turbidit√© " + turb;
      }
    },

    ru:{
      navHome:"–ì–ª–∞–≤–Ω–∞—è",navMeasure:"–ò–∑–º–µ—Ä–µ–Ω–∏–µ",navMap:"–ö–∞—Ä—Ç–∞",navFarm:"–ü–æ–º–æ—â—å —Ñ–µ—Ä–º–µ—Ä–∞–º",navCare:"–£—Ö–æ–¥",navChart:"–ì—Ä–∞—Ñ–∏–∫",navDetails:"–ü–æ–¥—Ä–æ–±–Ω–æ",
      pageTitle:"–ö–∞—Ä—Ç–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–¥—ã",
      intro:"–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç–µ. –ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å pH, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∏ –º—É—Ç–Ω–æ—Å—Ç—å, –∏ –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏ –ø–æ–º–æ—â–∏ —Ñ–µ—Ä–º–µ—Ä–∞–º.",
      filterLabel:"–ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω",
      filterAll:"–í—Å–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è",
      filterGood:"–•–æ—Ä–æ—à–∏–π (‚â• 70)",
      filterMed:"–°—Ä–µ–¥–Ω–∏–π (40‚Äì69)",
      filterPoor:"–ü–ª–æ—Ö–æ–π (< 40)",
      legGood:"–•–æ—Ä–æ—à–∏–π (–∏–Ω–¥–µ–∫—Å ‚â• 70)",
      legMed:"–°—Ä–µ–¥–Ω–∏–π (40‚Äì69)",
      legPoor:"–ü–ª–æ—Ö–æ–π (< 40)",
      legNoLoc:"–ó–∞–ø–∏—Å—å –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç",
      detailsTitle:"–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è",
      detailsEmpty:"–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ —Å—Ç—Ä–æ–∫—É –≤ —Å–ø–∏—Å–∫–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–¥–µ—Å—å.",
      recentTitle:"–ù–µ–¥–∞–≤–Ω–∏–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è",
      recentEmpty:"–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π. –°–¥–µ–ª–∞–π—Ç–µ –∏—Ö –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ò–∑–º–µ—Ä–µ–Ω–∏–µ –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞.",
      bandGood:"–•–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ",
      bandMed:"–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ",
      bandPoor:"–ü–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ",
      bandUnknown:"–ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞",
      noLocation:"–î–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –Ω–æ –µ—ë –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Å–æ–≤–µ—Ç–æ–≤ –ø–æ —É—Ö–æ–¥—É –∏ –≤—ã–±–æ—Ä—É –∫—É–ª—å—Ç—É—Ä.",
      detailsLine(when,place){
        let txt = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: " + when;
        if(place) txt += " ‚Ä¢ " + place;
        return txt;
      },
      detailsSub(ph,temp,turb,index){
        return "–ò–Ω–¥–µ–∫—Å " + index + " ‚Ä¢ pH " + ph + " ‚Ä¢ –¢–µ–º–ø. " + temp + "¬∞C ‚Ä¢ –ú—É—Ç–Ω–æ—Å—Ç—å " + turb;
      }
    },

    ja:{
      navHome:"„Éõ„Éº„É†",navMeasure:"Ë®àÊ∏¨",navMap:"Âú∞Âõ≥",navFarm:"Ëæ≤ÂÆ∂„Çµ„Éù„Éº„Éà",navCare:"„Ç±„Ç¢",navChart:"„ÉÅ„É£„Éº„Éà",navDetails:"Ë©≥Á¥∞",
      pageTitle:"Ê∞¥Ë≥™„Éû„ÉÉ„Éó",
      intro:"‰øùÂ≠ò„Åó„Åü„Åô„Åπ„Å¶„ÅÆÊ∏¨ÂÆöÁµêÊûú„Çí„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Å™Âú∞Âõ≥‰∏ä„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ„Éû„Éº„Ç´„Éº„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å® pH„ÉªÊ∏©Â∫¶„ÉªÊøÅÂ∫¶„ÅåË°®Á§∫„Åï„Çå„ÄÅ„Ç±„Ç¢„ÇÑËæ≤ÂÆ∂Âêë„Åë„Ç¢„Éâ„Éê„Ç§„Çπ„ÅÆ„Éö„Éº„Ç∏„Å´„ÇÇÁ∞°Âçò„Å´ÁßªÂãï„Åß„Åç„Åæ„Åô„ÄÇ",
      filterLabel:"Ë°®Á§∫„Åô„Çã„É©„É≥„ÇØ",
      filterAll:"„Åô„Åπ„Å¶„ÅÆÊ∏¨ÂÆö",
      filterGood:"ËâØÂ•Ω (‚â• 70)",
      filterMed:"ÊôÆÈÄö (40‚Äì69)",
      filterPoor:"ÊÇ™„ÅÑ (< 40)",
      legGood:"ËâØÂ•Ω (ÊåáÊï∞ ‚â• 70)",
      legMed:"ÊôÆÈÄö (40‚Äì69)",
      legPoor:"ÊÇ™„ÅÑ (< 40)",
      legNoLoc:"‰ΩçÁΩÆÊÉÖÂ†±„Å™„Åó„Åß‰øùÂ≠ò„Åï„Çå„ÅüÊ∏¨ÂÆöÂÄ§",
      detailsTitle:"Ê∏¨ÂÆö„ÅÆË©≥Á¥∞",
      detailsEmpty:"Âú∞Âõ≥‰∏ä„ÅÆ„Éû„Éº„Ç´„Éº„Åã„ÄÅÂè≥ÂÅ¥„ÅÆ‰∏ÄË¶ß„Åã„ÇâÊ∏¨ÂÆö„ÇíÈÅ∏„Å∂„Å®„ÄÅ„Åì„Åì„Å´Ë©≥Á¥∞„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ",
      recentTitle:"ÊúÄËøë„ÅÆÊ∏¨ÂÆö",
      recentEmpty:"„Åæ„Å†Ê∏¨ÂÆö„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇË®àÊ∏¨„Éö„Éº„Ç∏„ÅßÊ∏¨ÂÆö„Åó„Å¶„Åã„Çâ„ÄÅ„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
      bandGood:"Ê∞¥Ë≥™ÔºöËâØÂ•Ω",
      bandMed:"Ê∞¥Ë≥™ÔºöÊôÆÈÄö",
      bandPoor:"Ê∞¥Ë≥™ÔºöÊÇ™„ÅÑ",
      bandUnknown:"ÊåáÊï∞„Å™„Åó",
      noLocation:"„Åì„ÅÆÊ∏¨ÂÆö„Å´„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åå„ÄÅ„Ç±„Ç¢„ÇÑ‰ΩúÁâ©„Ç¢„Éâ„Éê„Ç§„Çπ„Å´„ÅØÂà©Áî®„Åß„Åç„Åæ„Åô„ÄÇ",
      detailsLine(when,place){
        let txt = "‰øùÂ≠òÊó•ÊôÇ: " + when;
        if(place) txt += " ‚Ä¢ " + place;
        return txt;
      },
      detailsSub(ph,temp,turb,index){
        return "ÊåáÊï∞ " + index + " ‚Ä¢ pH " + ph + " ‚Ä¢ Ê∏©Â∫¶ " + temp + "¬∞C ‚Ä¢ ÊøÅÂ∫¶ " + turb;
      }
    },

    zh:{
      navHome:"‰∏ªÈ°µ",navMeasure:"ÊµãÈáè",navMap:"Âú∞Âõæ",navFarm:"ÂÜúÊà∑Âä©Êâã",navCare:"ÂÖªÊä§",navChart:"ÂõæË°®",navDetails:"ËØ¶ÊÉÖ",
      pageTitle:"Ê∞¥Ë¥®Âú∞Âõæ",
      intro:"Âú®‰∫§‰∫íÂºèÂú∞Âõæ‰∏äÊü•Áúã‰Ω†‰øùÂ≠òÁöÑÊâÄÊúâÊ∞¥Ë¥®ËØªÊï∞„ÄÇÁÇπÂáªÊ†áËÆ∞Âç≥ÂèØÊü•Áúã pH„ÄÅÊ∏©Â∫¶ÂíåÊµëÊµäÂ∫¶ÔºåÂπ∂Âø´ÈÄüË∑≥ËΩ¨Âà∞ÂÖªÊä§ÂíåÂÜúÊà∑Âä©ÊâãÈ°µÈù¢„ÄÇ",
      filterLabel:"ÊòæÁ§∫Á≠âÁ∫ß",
      filterAll:"ÂÖ®ÈÉ®ËØªÊï∞",
      filterGood:"ËâØÂ•Ω (‚â• 70)",
      filterMed:"‰∏≠Á≠â (40‚Äì69)",
      filterPoor:"ËæÉÂ∑Æ (< 40)",
      legGood:"ËâØÂ•Ω (ÊåáÊï∞ ‚â• 70)",
      legMed:"‰∏≠Á≠â (40‚Äì69)",
      legPoor:"ËæÉÂ∑Æ (< 40)",
      legNoLoc:"Êú™‰øùÂ≠ò‰ΩçÁΩÆÁöÑËØªÊï∞",
      detailsTitle:"ËØªÊï∞ËØ¶ÊÉÖ",
      detailsEmpty:"ÁÇπÂáªÂú∞Âõæ‰∏äÁöÑÊ†áËÆ∞ÊàñÂè≥‰æßÂàóË°®‰∏≠ÁöÑ‰∏ÄÊù°ËÆ∞ÂΩïÔºåÂú®ËøôÈáåÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ",
      recentTitle:"ÊúÄËøëËØªÊï∞",
      recentEmpty:"ËøòÊ≤°Êúâ‰øùÂ≠ò‰ªª‰ΩïËØªÊï∞„ÄÇËØ∑ÂÖàÂú®‚ÄúÊµãÈáè‚ÄùÈ°µÈù¢‰øùÂ≠òËØªÊï∞ÔºåÁÑ∂ÂêéÂÜçÂõûÊù•Êü•Áúã„ÄÇ",
      bandGood:"Ê∞¥Ë¥®ÔºöËâØÂ•Ω",
      bandMed:"Ê∞¥Ë¥®Ôºö‰∏≠Á≠â",
      bandPoor:"Ê∞¥Ë¥®ÔºöËæÉÂ∑Æ",
      bandUnknown:"Êó†ÊåáÊï∞",
      noLocation:"ËøôÊù°ËØªÊï∞Ê≤°Êúâ‰øùÂ≠ò‰ΩçÁΩÆÔºå‰ΩÜ‰ªçÂèØ‰ª•Áî®‰∫éÂÖªÊä§Âíå‰ΩúÁâ©Âª∫ËÆÆ„ÄÇ",
      detailsLine(when,place){
        let txt = "‰øùÂ≠òÊó∂Èó¥Ôºö" + when;
        if(place) txt += " ‚Ä¢ " + place;
        return txt;
      },
      detailsSub(ph,temp,turb,index){
        return "ÊåáÊï∞ " + index + " ‚Ä¢ pH " + ph + " ‚Ä¢ Ê∏©Â∫¶ " + temp + "¬∞C ‚Ä¢ ÊµëÊµäÂ∫¶ " + turb;
      }
    }
  };

  const langSel = document.getElementById('langsel');
  let lang = localStorage.getItem('whilang') || 'en';
  langSel.value = lang;

  function t(){ return strings[lang] || strings.en; }

  function applyLang(){
    const s = t();
    document.getElementById('navHome').textContent    = s.navHome;
    document.getElementById('navMeasure').textContent = s.navMeasure;
    document.getElementById('navMap').textContent     = s.navMap;
    document.getElementById('navFarm').textContent    = s.navFarm;
    document.getElementById('navCare').textContent    = s.navCare;
    document.getElementById('navChart').textContent   = s.navChart;
    document.getElementById('navDetails').textContent = s.navDetails;

    document.getElementById('pageTitle').textContent  = s.pageTitle;
    document.getElementById('introText').textContent  = s.intro;
    document.getElementById('filterLabel').textContent= s.filterLabel;
    document.getElementById('filterAll').textContent  = s.filterAll;
    document.getElementById('filterGood').textContent = s.filterGood;
    document.getElementById('filterMed').textContent  = s.filterMed;
    document.getElementById('filterPoor').textContent = s.filterPoor;
    document.getElementById('legGood').textContent    = s.legGood;
    document.getElementById('legMed').textContent     = s.legMed;
    document.getElementById('legPoor').textContent    = s.legPoor;
    document.getElementById('legNoLoc').textContent   = s.legNoLoc;
    document.getElementById('detailsTitle').textContent = s.detailsTitle;
    document.getElementById('recentTitle').textContent  = s.recentTitle;
    document.getElementById('recentEmpty').textContent  = s.recentEmpty;
    document.getElementById('detailsMain').textContent  = s.detailsEmpty;
  }
  applyLang();

  langSel.addEventListener('change',()=>{
    lang = langSel.value;
    localStorage.setItem('whilang',lang);
    applyLang();
    renderRecentList();
    if(selectedId!=null) showDetailsById(selectedId);
  });

  // -------------- map + data --------------
  const map = L.map('mapAll',{zoomControl:true,scrollWheelZoom:false}).setView([23,80],4.5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:14,
    attribution:'¬© OpenStreetMap'
  }).addTo(map);

  let readings = [];
  try{
    readings = JSON.parse(localStorage.getItem('whReadings') || "[]");
    if(!Array.isArray(readings)) readings = [];
  }catch(e){readings=[];}

  // add ids to readings
  readings.forEach((r,i)=>{ if(r.id==null) r.id = i; });

  // classify band
  function bandForIndex(idx){
    idx = Number(idx);
    if(isNaN(idx)) return "unknown";
    if(idx>=70) return "good";
    if(idx>=40) return "med";
    return "poor";
  }

  // marker layer
  const markers = [];
  const markerLayer = L.layerGroup().addTo(map);

  function markerColor(band){
    if(band==="good") return "#26c96a";
    if(band==="med")  return "#f1c644";
    if(band==="poor") return "#e0526a";
    return "#78909c";
  }

  function createMarker(r){
    if(typeof r.lat!=="number" || typeof r.lng!=="number") return null;
    const band = bandForIndex(r.index);
    const color = markerColor(band);
    const marker = L.circleMarker([r.lat,r.lng],{
      radius:7,
      color:"#0a141a",
      weight:1.5,
      fillColor:color,
      fillOpacity:0.9
    });
    const popupHtml = `
      <div style="font-size:12px;">
        <div><strong>Index ${r.index ?? "‚Äì"} (${band.toUpperCase()})</strong></div>
        <div style="margin-top:2px;">pH ${r.ph ?? "‚Äì"} ‚Ä¢ Temp ${r.temp ?? "‚Äì"}¬∞C</div>
        <div style="margin-top:2px;">Turbidity: ${r.turb ?? "‚Äì"}</div>
      </div>
    `;
    marker.bindPopup(popupHtml);
    marker.on('click',()=>{
      selectedId = r.id;
      showDetails(r);
      highlightRecent(r.id);
    });
    return marker;
  }

  function rebuildMarkers(){
    markerLayer.clearLayers();
    markers.length = 0;
    const filter = document.getElementById('bandFilter').value;
    readings.forEach(r=>{
      const band = bandForIndex(r.index);
      if(filter!=="all" && band!==filter) return;
      const m = createMarker(r);
      if(m){
        m.addTo(markerLayer);
        markers.push({id:r.id,marker:m,band});
      }
    });
    if(markers.length){
      const group = L.featureGroup(markers.map(m=>m.marker));
      map.fitBounds(group.getBounds().pad(0.15));
    }
  }

  document.getElementById('bandFilter').addEventListener('change',rebuildMarkers);
  rebuildMarkers();

  // -------------- details + recent list --------------
  const recentList   = document.getElementById('recentList');
  const recentEmpty  = document.getElementById('recentEmpty');
  let selectedId = null;

  function renderRecentList(){
    const s = t();
    recentList.innerHTML = "";
    const list = readings.slice().reverse(); // newest first
    if(!list.length){
      const div=document.createElement('div');
      div.className="recent-empty";
      div.textContent=s.recentEmpty;
      recentList.appendChild(div);
      return;
    }
    list.forEach(r=>{
      const div=document.createElement('div');
      div.className="recent-item";
      div.dataset.id = r.id;
      const dot=document.createElement('div');
      dot.className="recent-dot";
      dot.style.background=markerColor(bandForIndex(r.index));
      const main=document.createElement('div');
      main.className="recent-main";
      const when=document.createElement('div');
      when.className="recent-when";
      when.textContent=r.when || "";
      const idx=document.createElement('div');
      idx.className="recent-index";
      idx.textContent="Index " + (r.index ?? "‚Äì") + ", pH " + (r.ph ?? "‚Äì");
      main.appendChild(when);
      main.appendChild(idx);
      div.appendChild(dot);
      div.appendChild(main);
      div.addEventListener('click',()=>{
        selectedId = r.id;
        showDetails(r);
        highlightRecent(r.id);
        if(typeof r.lat==="number" && typeof r.lng==="number"){
          map.setView([r.lat,r.lng], 12);
        }
      });
      recentList.appendChild(div);
    });
  }

  function highlightRecent(id){
    const items = recentList.querySelectorAll('.recent-item');
    items.forEach(it=>{
      if(Number(it.dataset.id)===id) it.classList.add('active');
      else it.classList.remove('active');
    });
  }

  function showDetails(r){
    const s = t();
    const main = document.getElementById('detailsMain');
    const sub  = document.getElementById('detailsSub');
    const note = document.getElementById('detailsNote');

    main.textContent = s.detailsLine(r.when || "‚Äì", r.place || "");
    sub.textContent  = s.detailsSub(r.ph ?? "‚Äì", r.temp ?? "‚Äì", r.turb ?? "‚Äì", r.index ?? "‚Äì");

    note.textContent = "";
    if(typeof r.lat!=="number" || typeof r.lng!=="number"){
      note.textContent = s.noLocation;
    }

    // band badge
    const band = bandForIndex(r.index);
    let bandText=s.bandUnknown, bandClass="band-unknown";
    if(band==="good"){bandText=s.bandGood; bandClass="band-good";}
    else if(band==="med"){bandText=s.bandMed; bandClass="band-med";}
    else if(band==="poor"){bandText=s.bandPoor; bandClass="band-poor";}
    // append badge into main
    main.innerHTML = main.textContent + " ";
    const span=document.createElement('span');
    span.className="band-badge "+bandClass;
    span.textContent=bandText;
    document.getElementById('detailsMain').innerHTML="";
    document.getElementById('detailsMain').appendChild(document.createTextNode(s.detailsLine(r.when || "‚Äì", r.place || "")));
    document.getElementById('detailsMain').appendChild(document.createTextNode(" "));
    document.getElementById('detailsMain').appendChild(span);
    document.getElementById('detailsSub').textContent = s.detailsSub(r.ph ?? "‚Äì", r.temp ?? "‚Äì", r.turb ?? "‚Äì", r.index ?? "‚Äì");
    document.getElementById('detailsNote').textContent = (typeof r.lat!=="number" || typeof r.lng!=="number") ? s.noLocation : "";
  }

  function showDetailsById(id){
    const r = readings.find(x=>x.id===id);
    if(r) showDetails(r);
  }

  renderRecentList();

});
</script>

</body>
</html>
