<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Water Health Index ‚Äì Measure</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root {
  --dark-bg: #184757; --header: #e3fbfa; --mainblue: #39bbe9; --accent-teal: #55ebca; --card-bg: #213a4a;
  --btn: #2cb5d6; --btn-hov: #168eaf; --btn2: #e0526a; --btn2-hov: #c32d44;
  --input-bg: #203a46; --input-fg: #e9fff5;
}
html,body {min-height:100%;margin:0;padding:0;font-family:"Times New Roman",Times,serif;background:linear-gradient(135deg,#215871 0%,#184757 100%);}
nav {display:flex;align-items:center;justify-content:space-between;padding:1.1rem 2.2rem 0.3rem 2.2rem;}
.logo {font-weight:bold;font-size:2.2rem;display:flex;align-items:center;gap:0.7rem;font-family:"Times New Roman";}
.logo .waveemoji {font-size:2.6rem;animation:floatTide 2s infinite alternate cubic-bezier(.55,.06,.87,.6);}
@keyframes floatTide {0%{transform:translateY(0);}100%{transform:translateY(-10px);}}
.nav-links{display:flex;gap:2rem;align-items:center;}
.nav-links a{color:var(--header);font-weight:bold;text-decoration:none;padding-bottom:2px;border-bottom:2px solid transparent;transition:color .18s,border-bottom .18s;}
.nav-links a.active,.nav-links a:hover{color:var(--accent-teal);border-bottom:2px solid var(--accent-teal);}
.langbar select{font-family:inherit;font-size:1.11rem;border-radius:7px;padding:0.32rem 0.9rem;border:1.4px solid #74c6e0;background:#15313e;color:var(--mainblue);font-weight:700;}
main{max-width:1050px;margin:3vw auto 2vw auto;background:var(--card-bg);border-radius:17px;box-shadow:0px 8px 38px rgba(36,210,143,0.08);padding:2.8rem 2.1rem 3.4rem;}
h1{font-size:2.5rem;font-family:"Times New Roman";color:var(--accent-teal);margin-bottom:.6rem;text-align:center;font-weight:900;}
.form-row{display:flex;flex-wrap:wrap;gap:2.2rem;justify-content:space-between;}
.form-card{flex:1 1 370px;background:#253c4d;border-radius:16px;padding:1.8rem 1.6rem;box-shadow:0 3px 18px #14849b14;display:flex;flex-direction:column;}
.form-card label{font-weight:700;font-size:1.055rem;color:var(--mainblue);}
input,select{border-radius:8px;border:none;padding:0.6rem 0.9rem;font-size:1.08rem;font-family:"Times New Roman";background:var(--input-bg);color:var(--input-fg);margin-bottom:1.13rem;}
.form-btns{display:flex;flex-wrap:wrap;gap:0.68rem;margin-bottom:1.08rem;}
button{padding:0.62rem 1.2rem;font-size:1.11rem;border-radius:8px;border:none;font-family:"Times New Roman";font-weight:700;cursor:pointer;transition:background .18s;}
.btn-p{background:var(--btn);color:#fff;}
.btn-p:hover{background:var(--btn-hov);}
.btn-w{background:var(--btn2);color:#fff;}
.btn-w:hover{background:var(--btn2-hov);}
.locinfo{color:var(--mainblue);font-weight:700;font-size:.98rem;margin:.19rem 0 1.1rem 0;}
.status-card{margin-top:0.18rem;background:#0f2920d6;border-radius:13px;padding:1.1rem 1.1rem .9rem 1.31rem;color:#aff3d1;display:flex;align-items:center;gap:1rem;box-shadow:0 0 10px #14a67b70;transition:box-shadow .2s;}
.status-good .status-score{background:#15a573;}
.status-mod .status-score{background:#a8a14e;}
.status-bad .status-score{background:#b94a48;}
.status-score{font-size:2.1rem;font-weight:900;width:55px;height:55px;line-height:55px;text-align:center;border-radius:50%;background:#15a573;color:#fff;flex-shrink:0;box-shadow:0 0 15px #00c89138;}
.status-info{font-size:1.06rem;}
.status-info strong{font-weight:700;}
.status-info .label{color:#17c8aa;}
.map-side{flex:1 1 370px;background:#253c4d;border-radius:16px;padding:1rem 1.2rem;max-height:346px;}
#mini-map{height:320px;border-radius:11px;}
.maptxt{color:#a6fedb;font-size:.95rem;text-align:right;margin-top:.61rem;}
img,canvas,video{display:block;margin:0.4rem auto 0.1rem;max-width:98%;border-radius:8px;}
.photoView{background:#111;box-shadow:0 2px 12px #29e6a24b;}
.form-btns .det-ph-btn{background:#385fd7;color:#fff;}
.form-btns .det-ph-btn:hover{background:#2447a0;}
.history-title{font-weight:700;margin:2.18rem 0 .47rem 0;color:var(--mainblue);font-size:1.20rem;letter-spacing:.01em;}
.history-table{width:100%;border-collapse:collapse;background:#1c3140cc;font-size:1.01rem;}
.history-table th,.history-table td{padding:.59rem .8rem;border-bottom:1.13px solid #265357;color:#c3eeea;text-align:left;}
.history-table th{color:var(--accent-teal);font-weight:700;background:#203a4f;}
@media (max-width:910px){main{padding:.7rem .4rem 2.1rem;}.form-row{flex-direction:column;}}
@media (max-width:540px){main{padding:0.4rem 0.1rem;}}
</style>
</head>
<body>
<nav>
  <div class="logo">
    <span class="waveemoji" aria-hidden="true">üåä</span>
    Water Health Index
  </div>
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="measure.html" class="active">Measure</a>
    <a href="map.html">Map</a>
    <a href="farmers.html">Farmers Assistance</a>
    <a href="care.html">Care</a>
    <a href="chart.html">Chart</a>
    <a href="details.html">Details</a>
    <span class="langbar">
      <select id="langsel" aria-label="Select language">
        <option value="en">English</option>
        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
      </select>
    </span>
  </div>
</nav>
<main>
  <h1 id="main-title">Measure Water Quality</h1>
  <div class="form-row">
    <div class="form-card">
      <label id="lbl-ph" for="ph">pH (0.0 - 14.0)</label>
      <input type="number" id="ph" min="0" max="14" step="0.1" required placeholder="7.0"/>
      <label id="lbl-temp" for="temp">Temperature (¬∞C)</label>
      <input type="number" id="temp" min="-10" max="70" step="0.1" required placeholder="25"/>
      <label id="lbl-turb" for="turbidity">Turbidity</label>
      <select id="turbidity" required>
        <option value="" disabled selected>Select turbidity</option>
        <option value="Low">Low ‚Äî Clear</option>
        <option value="Medium">Medium ‚Äî Cloudy</option>
        <option value="High">High ‚Äî Muddy</option>
      </select>
      <div class="form-btns">
        <button type="button" id="cameraBtn" class="btn-p">Camera</button>
        <button type="button" id="switchCamBtn" class="btn-p">Switch Camera</button>
        <button type="button" id="detPhBtn" class="btn-p det-ph-btn">Detect pH</button>
        <button type="button" id="locBtn" class="btn-p">Use My Location</button>
      </div>
      <video id="cameraView" autoplay playsinline muted style="display:none;"></video>
      <canvas id="phCanvas" style="display:none;border:2px solid #294a6c;"></canvas>
      <div class="locinfo" id="locationInfo"></div>
      <div class="form-btns">
        <button type="button" id="analyzeBtn" class="btn-p">Analyze</button>
        <button type="button" id="clearReadingsBtn" class="btn-w">Clear History</button>
      </div>
      <div id="statusCard" class="status-card" hidden>
        <div id="statusScore" class="status-score">--</div>
        <div class="status-info">
          <strong id="statusTag">Status:</strong>
          <span id="statusText"></span><br/>
          <small id="statusMsg"></small><br/>
          <small>
            <em>pH:</em> <span id="statusPh"></span>&nbsp;‚Ä¢&nbsp;<em>Temp:</em> <span id="statusTemp"></span>&nbsp;‚Ä¢&nbsp;<em>Turbidity:</em> <span id="statusTurb"></span>
          </small>
        </div>
      </div>
    </div>
    <div class="map-side">
      <div id="mini-map"></div>
      <div class="maptxt" id="mapLegend">Your saved readings appear here.<br>Green=Good, Yellow=Moderate, Red=Poor</div>
    </div>
  </div>
  <div class="history-title" id="history-title">Saved Readings</div>
  <table class="history-table">
    <thead>
      <tr><th>When</th><th>pH</th><th>Temp</th><th>Turb</th><th>Index</th></tr>
    </thead>
    <tbody id="historyBody"><tr><td colspan="5" style="color:#77a9a8">No readings saved.</td></tr></tbody>
  </table>
</main>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Translation/demo logic
const translations = {
  en: {
    mainTitle:"Measure Water Quality",lblPh:"pH (0.0 - 14.0)",lblTemp:"Temperature (¬∞C)",lblTurb:"Turbidity",
    camera:"Camera",switchCam:"Switch Camera",geo:"Use My Location",detPh:"Detect pH",analyze:"Analyze",clear:"Clear History",
    histTitle:"Saved Readings",legend:"Your saved readings appear here.<br>Green=Good, Yellow=Moderate, Red=Poor",noReadings:"No readings saved.",
    statusTag:"Status:",
    statusDescs:["Hazardous for all use.","Severe contamination detected.","Toxic water: avoid all use.","Extremely polluted, unsafe.","Worsening quality, immediate caution.","Very poor: use with strong filtration.","Significant contamination.","Unsafe for drinking, may be fit for cleaning only.","Marginal quality, restrict use.","Low quality, questionable for any use.","Between poor and moderate.","Moderate/Needs treatment before potable.","Use with caution; moderate risk.","Partially safe, not ideal.","Mixed quality, minor treatment needed.","Somewhat good.","Approaching fair quality.","Fair ‚Äì Safe for non-essential uses.","Fairly good, basic filtration suggested.","Good quality, generally safe.","Healthy water, minimal risk.","Healthy and clear.","Very Good quality.","Potable and healthy.","Excellent‚Äîminimal stress.","Pristine, best possible quality."],
    statusRanges:[4,8,12,16,20,28,34,40,45,50,54,58,62,66,70,74,77,81,84,87,91,94,97,99,100]
  },
  hi: {
    mainTitle:[translate:"‡§ú‡§≤ ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§Æ‡§æ‡§™‡§®"],lblPh:[translate:"‡§™‡•Ä‡§è‡§ö (0.0 - 14.0)"],lblTemp:[translate:"‡§§‡§æ‡§™‡§Æ‡§æ‡§® (¬∞C)"],lblTurb:[translate:"‡§Ö‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡§§‡§æ"],
    camera:[translate:"‡§ï‡•à‡§Æ‡§∞‡§æ"],switchCam:[translate:"‡§ï‡•à‡§Æ‡§∞‡§æ ‡§¨‡§¶‡§≤‡•á‡§Ç"],geo:[translate:"‡§Æ‡•á‡§∞‡§æ ‡§∏‡•ç‡§•‡§æ‡§®"],detPh:[translate:"pH ‡§™‡§§‡§æ ‡§ï‡§∞‡•á‡§Ç"],analyze:[translate:"‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£"],clear:[translate:"‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç"],
    histTitle:[translate:"‡§∏‡§π‡•á‡§ú‡•á ‡§ó‡§è ‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó‡•ç‡§∏"],legend:[translate:"‡§Ü‡§™‡§ï‡•Ä ‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡•á‡§Ç‡§ó‡•Ä.<br>‡§π‡§∞‡§æ=‡§Ö‡§ö‡•ç‡§õ‡§æ, ‡§™‡•Ä‡§≤‡§æ=‡§Æ‡§ß‡•ç‡§Ø‡§Æ, ‡§≤‡§æ‡§≤=‡§ñ‡§∞‡§æ‡§¨"],noReadings:[translate:"‡§ï‡•ã‡§à ‡§∞‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç."],
    statusTag:[translate:"‡§∏‡•ç‡§•‡§ø‡§§‡§ø:"],
    statusDescs:[[translate:"‡§∏‡§≠‡•Ä ‡§â‡§™‡§Ø‡•ã‡§ó ‡§π‡•á‡§§‡•Å ‡§ñ‡§§‡§∞‡§®‡§æ‡§ï."],[translate:"‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§ï‡§æ ‡§∏‡•ç‡§§‡§∞‡•§"],[translate:"‡§ñ‡§§‡§∞‡§®‡§æ‡§ï ‡§ú‡§≤: ‡§â‡§™‡§Ø‡•ã‡§ó ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§"],[translate:"‡§Ö‡§§‡•ç‡§Ø‡§ß‡§ø‡§ï ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§ø‡§§, ‡§Ö‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§."],[translate:"‡§ó‡§ø‡§∞‡§§‡•Ä ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ, ‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§∏‡§§‡§∞‡•ç‡§ï‡§§‡§æ ‡§ú‡§∞‡•Ç‡§∞‡•Ä."],[translate:"‡§¨‡§π‡•Å‡§§ ‡§ñ‡§∞‡§æ‡§¨: ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•Ä‡§µ‡•ç‡§∞ ‡§®‡§ø‡§∏‡•ç‡§™‡§Ç‡§¶‡§® ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï."],[translate:"‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£."],[translate:"‡§™‡•Ä‡§®‡•á ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç; ‡§ï‡•á‡§µ‡§≤ ‡§∏‡§´‡§æ‡§à ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à."],[translate:"‡§∏‡•Ä‡§Æ‡§æ‡§Ç‡§§ ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ, ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§∏‡•Ä‡§Æ‡§ø‡§§ ‡§∞‡§ñ‡•á‡§Ç."],[translate:"‡§ï‡§Æ ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ, ‡§ï‡§ø‡§∏‡•Ä ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§Ç‡§¶‡•á‡§π‡§æ‡§∏‡•ç‡§™‡§¶."],[translate:"‡§ñ‡§∞‡§æ‡§¨ ‡§î‡§∞ ‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§ï‡•á ‡§¨‡•Ä‡§ö."],[translate:"‡§Æ‡§ß‡•ç‡§Ø‡§Æ/‡§™‡•á‡§Ø‡§ú‡§≤ ‡§π‡•á‡§§‡•Å ‡§â‡§™‡§ö‡§æ‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï."],[translate:"‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡•Ä ‡§ï‡•á ‡§∏‡§æ‡§• ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç; ‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§ú‡•ã‡§ñ‡§ø‡§Æ."],[translate:"‡§Ü‡§Ç‡§∂‡§ø‡§ï ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§, ‡§Ü‡§¶‡§∞‡•ç‡§∂ ‡§®‡§π‡•Ä‡§Ç."],[translate:"‡§Æ‡§ø‡§∂‡•ç‡§∞‡§ø‡§§ ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ, ‡§Æ‡§æ‡§Æ‡•Ç‡§≤‡•Ä ‡§â‡§™‡§ö‡§æ‡§∞ ‡§ú‡§∞‡•Ç‡§∞‡•Ä."],[translate:"‡§ï‡•Å‡§õ ‡§π‡§¶ ‡§§‡§ï ‡§Ö‡§ö‡•ç‡§õ‡§æ."],[translate:"‡§Æ‡§ß‡•Å‡§∞ ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§ï‡•á ‡§ï‡§∞‡•Ä‡§¨."],[translate:"‡§†‡•Ä‡§ï-‡§†‡§æ‡§ï ‚Äì ‡§ó‡•à‡§∞-‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§π‡•á‡§§‡•Å ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§."],[translate:"‡§ï‡§æ‡§´‡•Ä ‡§Ö‡§ö‡•ç‡§õ‡§æ, ‡§Æ‡•Ç‡§≤ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡•Ä ‡§∏‡§≤‡§æ‡§π."],[translate:"‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ, ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§Ç‡§∂‡§§‡§É ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§."],[translate:"‡§∏‡•ç‡§µ‡§∏‡•ç‡§• ‡§µ ‡§∏‡•ç‡§µ‡§ö‡•ç‡§õ ‡§ú‡§≤."],[translate:"‡§¨‡§π‡•Å‡§§ ‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ."],[translate:"‡§™‡•á‡§Ø ‡§ú‡§≤ ‡§è‡§µ‡§Ç ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø‡§µ‡§∞‡•ç‡§ß‡§ï."],[translate:"‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü‚Äî‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§§‡§®‡§æ‡§µ."],[translate:"‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü, ‡§∏‡§∞‡•ç‡§µ‡•ã‡§§‡•ç‡§§‡§Æ ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ."]],
    statusRanges:[4,8,12,16,20,28,34,40,45,50,54,58,62,66,70,74,77,81,84,87,91,94,97,99,100]
  }
};
function _(k){return translations[window.lang][k]||translations.en[k]||k;}
window.lang = localStorage.getItem('whilang')||'en';
document.getElementById('langsel').value=window.lang;
document.getElementById('langsel').addEventListener('change',e=>{
  window.lang = e.target.value; localStorage.setItem('whilang',window.lang); transUI();
});
function transUI(){
  document.getElementById('main-title').innerHTML = _( 'mainTitle' );
  document.getElementById('lbl-ph').innerHTML = _( 'lblPh' );
  document.getElementById('lbl-temp').innerHTML = _( 'lblTemp' );
  document.getElementById('lbl-turb').innerHTML = _( 'lblTurb' );
  document.getElementById('cameraBtn').innerHTML = _( 'camera' );
  document.getElementById('switchCamBtn').innerHTML = _( 'switchCam' );
  document.getElementById('detPhBtn').innerHTML = _( 'detPh' );
  document.getElementById('locBtn').innerHTML = _( 'geo' );
  document.getElementById('analyzeBtn').innerHTML = _( 'analyze' );
  document.getElementById('clearReadingsBtn').innerHTML = _( 'clear' );
  document.getElementById('history-title').innerHTML = _( 'histTitle' );
  document.getElementById('mapLegend').innerHTML = _( 'legend' );
}
window.onload = ()=>{ transUI(); renderHistory(); initMap(); };

// MAP
let map, marker;
function initMap(){
  map = L.map('mini-map',{zoomControl:true,scrollWheelZoom:false}).setView([23,86], 4.7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:13,attribution:'&copy; OpenStreetMap'}).addTo(map);
}

// GEO
async function geocodeLatLng(lat,lng){
  let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
  let data = await res.json(); return data.display_name || "Unknown Location";
}
document.getElementById('locBtn').onclick=()=>{
  if(!navigator.geolocation){alert("Geolocation not supported.");return;}
  navigator.geolocation.getCurrentPosition(async pos=>{
    let lat=pos.coords.latitude,lng=pos.coords.longitude,addr=await geocodeLatLng(lat,lng);
    document.getElementById('locationInfo').innerText = addr;
    if(!marker){ marker = L.marker([lat,lng]).addTo(map);}
    else{ marker.setLatLng([lat,lng]); }
    map.setView([lat,lng],12);
  },()=>alert("Unable to retrieve location."));
};

// Camera/Dectect pH
let camStream=null, currentCam="environment", photoData=null;
const video=document.getElementById('cameraView'), canvas=document.getElementById('phCanvas'), ctx=canvas.getContext('2d');
document.getElementById('cameraBtn').onclick = async function() {
  canvas.style.display='none';
  if(camStream){ camStream.getTracks().forEach(t=>t.stop());camStream=null;video.style.display='none';return;}
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:currentCam}});
    video.srcObject=camStream; video.style.display='block'; video.play();
  }catch{ alert("Cannot open camera."); }
};
document.getElementById('switchCamBtn').onclick=function(){
  currentCam=(currentCam==="environment")?"user":"environment";
  if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null;video.style.display='none';}
};
// Photo->Detect ph
document.getElementById('detPhBtn').onclick=function(){
  // 1. Snap a frame to canvas
  if(!video.srcObject){alert("Open camera first.");return;}
  let vw=video.videoWidth||320, vh=video.videoHeight||240;
  canvas.width=vw; canvas.height=vh;
  ctx.drawImage(video,0,0,vw,vh);
  canvas.style.display='block';
  video.style.display='none';
  camStream&&camStream.getTracks().forEach(t=>t.stop());camStream=null;
  // 2. On click, get pixel color and compute fake pH (for demo)
  canvas.onclick=function(e){
    let rect = canvas.getBoundingClientRect();
    let x = Math.floor((e.clientX-rect.left)*canvas.width/rect.width);
    let y = Math.floor((e.clientY-rect.top)*canvas.height/rect.height);
    let rgb=ctx.getImageData(x,y,1,1).data;
    // Simple "map" for demo: hue range
    let [r,g,b]=rgb,hue=Math.atan2(Math.sqrt(3)*(g-b),2*r-g-b)*180/Math.PI; // Between -180..180
    hue = (hue+360)%360;
    let ph = Math.round( ((hue-60)/200)*7 + 7 );
    ph = Math.max(0,Math.min(14,ph||7));
    document.getElementById('ph').value=ph;
    alert("Color read: ("+r+","+g+","+b+")\nDemo pH: "+ph);
    canvas.style.display='none';
    video.style.display='none';
  };
};

// Analyze, Save, History
function calcIndex(ph,temp,turb){return Math.max(0,Math.min(100,Math.round(100-Math.abs(7-ph)*8-(40-temp)*.9-(turb==="High"?18:(turb==="Medium"?6:0)))));}
function analyzeReading(){
  let ph=parseFloat(document.getElementById('ph').value);
  let temp=parseFloat(document.getElementById('temp').value);
  let tur=document.getElementById('turbidity').value;
  if(isNaN(ph)||isNaN(temp)||!tur){alert("Fill all fields!");return;}
  let index=calcIndex(ph,temp,tur),desc="",ranges=_( 'statusRanges' ),msgs=_( 'statusDescs' );
  for(let i=0;i<ranges.length;i++){if(index<=ranges[i]){desc=msgs[i];break;}}
  let score=document.getElementById('statusScore'),msg=document.getElementById('statusMsg'),tag=document.getElementById('statusText'),card=document.getElementById('statusCard'),phEl=document.getElementById('statusPh'),tempEl=document.getElementById('statusTemp'),turbEl=document.getElementById('statusTurb'),taglab=document.getElementById('statusTag');
  score.innerHTML=index;
  msg.innerHTML=desc; tag.innerHTML=desc?desc.split(":")[0]:"";
  phEl.innerHTML=ph; tempEl.innerHTML=temp+"¬∞C"; turbEl.innerHTML=tur;
  card.className="status-card";
  if(index>=80)card.classList.add("status-good");
  else if(index>=60)card.classList.add("status-mod");
  else card.classList.add("status-bad");
  taglab.innerHTML=_( 'statusTag' );
  card.hidden=false;
  saveReading(ph,temp,tur,index);
}
document.getElementById('analyzeBtn').onclick=analyzeReading;
function saveReading(ph,temp,tur,index){
  let now=new Date().toLocaleString(),history=JSON.parse(localStorage.getItem('waterHistory')||'[]');
  history.push({when:now,ph,temp,turbidity:tur,index});localStorage.setItem('waterHistory',JSON.stringify(history));renderHistory();
}
document.getElementById('clearReadingsBtn').onclick=function(){if(confirm("Clear all saved readings?")){localStorage.removeItem('waterHistory');renderHistory();}};
function renderHistory(){
  let tbody=document.getElementById('historyBody'),h=JSON.parse(localStorage.getItem('waterHistory')||'[]');
  tbody.innerHTML=h.length?"" : `<tr><td colspan="5">${_( 'noReadings')}</td></tr>`;
  h.slice().reverse().forEach(r=>{
    let row=document.createElement('tr');
    row.innerHTML=`<td>${r.when}</td><td>${r.ph}</td><td>${r.temp}</td><td>${r.turbidity}</td><td>${r.index}</td>`;tbody.appendChild(row);
  });
}
</script>
</body>
</html>
