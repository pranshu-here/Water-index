<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Water Health Index ‚Äì Measure</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root{
  --bg1:#215871;
  --bg2:#184757;
  --card:#213a4a;
  --card2:#253c4d;
  --text:#e3fbfa;
  --accent:#55ebca;
  --accent2:#39bbe9;
  --pin:#ffcf66;
  --btn:#2cb5d6;
  --btn-hover:#168eaf;
  --btn-danger:#e0526a;
  --btn-danger-hover:#c32d44;
}
*{box-sizing:border-box;}
body{margin:0;font-family:"Times New Roman",Times,serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);}
nav{display:flex;align-items:center;justify-content:space-between;padding:1.1rem 2.2rem 0.3rem 2.2rem;}
.logo{display:flex;align-items:center;gap:0.7rem;font-weight:bold;font-size:2.2rem;}
.logo .wave{font-size:2.6rem;animation:floatWave 2s infinite alternate ease-in-out;}
@keyframes floatWave{0%{transform:translateY(0);}100%{transform:translateY(-10px);}}
.nav-links{display:flex;gap:2rem;align-items:center;}
.nav-links a{color:var(--text);text-decoration:none;font-weight:bold;padding-bottom:2px;border-bottom:2px solid transparent;}
.nav-links a.active,.nav-links a:hover{color:var(--accent);border-bottom-color:var(--accent);}
.langbar select{font-family:inherit;font-size:1.05rem;border-radius:7px;padding:0.32rem 0.9rem;border:1.3px solid #74c6e0;background:#15313e;color:var(--accent2);font-weight:bold;}
main{max-width:1100px;margin:3vw auto 2.5vw auto;background:var(--card);border-radius:17px;padding:2.3rem 1.7rem 2.5rem;box-shadow:0 8px 28px rgba(0,0,0,0.25);}
h1{text-align:center;color:var(--accent);margin:0 0 1.6rem 0;font-size:2.4rem;}
.layout{display:flex;flex-wrap:wrap;gap:2rem;}
.left,.right{flex:1 1 360px;}
.card{background:var(--card2);border-radius:16px;padding:1.4rem 1.3rem 1.7rem;}
label{display:block;font-weight:bold;color:var(--accent2);font-size:1.02rem;}
input,select{width:100%;border-radius:8px;border:none;margin:.45rem 0 1.05rem 0;padding:.55rem .8rem;font-size:1rem;background:#203a46;color:#e9fff5;}
.small-hint{font-size:.84rem;color:#b8e9ff;margin:-.4rem 0 0.7rem 0.1rem;}
.buttons-row{display:flex;flex-wrap:wrap;gap:.7rem;margin:.45rem 0 1rem 0;}
button{border:none;border-radius:8px;padding:.62rem 1.1rem;font-family:"Times New Roman",Times,serif;font-size:1.02rem;font-weight:bold;cursor:pointer;}
.btn-main{background:var(--btn);color:#fff;}
.btn-main:hover{background:var(--btn-hover);}
.btn-danger{background:var(--btn-danger);color:#fff;}
.btn-danger:hover{background:var(--btn-danger-hover);}
#cameraView,#phCanvas{display:none;width:100%;margin:.7rem 0 0 0;border-radius:10px;}
.cam-card{margin-top:0.6rem;background:#f3fbff;border-radius:14px;padding:1rem 1rem 1.1rem;color:#123344;}
.cam-title{font-weight:bold;margin-bottom:.4rem;color:#1f4d6a;}
.cam-box{position:relative;border-radius:12px;overflow:hidden;background:#000;}
.cam-overlay{position:absolute;top:50%;left:50%;width:70px;height:70px;margin:-35px 0 0 -35px;border:2px dashed rgba(255,255,255,0.8);border-radius:8px;pointer-events:none;}
.cam-buttons{margin-top:.6rem;}
.cam-info{font-size:.89rem;margin-top:.45rem;color:#234a63;}
/* Location pill card */
.loc-card{display:flex;align-items:center;gap:.7rem;background:#163846;border:1px solid #2d6e84;color:#dffbff;border-radius:12px;padding:.6rem .9rem;margin:.9rem 0 1.1rem 0;box-shadow:0 8px 18px rgba(0,0,0,0.18);}
.loc-pin{width:28px;height:28px;border-radius:50%;background:var(--pin);color:#14333f;display:flex;align-items:center;justify-content:center;font-weight:900;}
.loc-text{font-size:.98rem;font-weight:700;line-height:1.3;}
.loc-sub{font-size:.86rem;color:#a9d7e6;}
.status-card{display:none;margin-top:.7rem;background:#f0fff5;border-radius:18px;padding:0.9rem 1.1rem 1rem;color:#145332;box-shadow:0 8px 25px rgba(0,0,0,0.18);gap:1rem;align-items:center;}
.status-circle{width:70px;height:70px;border-radius:50%;background:#1cc96a;color:#fff;font-size:2rem;font-weight:900;text-align:center;line-height:70px;box-shadow:0 10px 25px rgba(0,0,0,0.25);}
.status-details{flex:1;}
.status-badge{display:inline-block;background:#1c6b3f;color:#fff;padding:0.15rem 0.7rem;border-radius:999px;font-size:.82rem;font-weight:bold;margin-left:.4rem;}
.status-sub{font-size:.89rem;margin-top:.2rem;}
.status-desc{display:inline-block;margin-top:.4rem;padding:.22rem .55rem;border-radius:9px;background:#e3ffe9;}
#map{width:100%;height:260px;border-radius:10px;}
.map-caption{margin-top:.6rem;font-size:.9rem;color:#a6fedb;text-align:right;}
.history-title{margin:2.1rem 0 .55rem 0;font-weight:bold;color:var(--accent2);}
table{width:100%;border-collapse:collapse;background:#1c3140cc;}
th,td{padding:.5rem .7rem;border-bottom:1px solid #265357;font-size:.94rem;}
th{color:var(--accent2);background:#203a4f;}
@media(max-width:900px){.layout{flex-direction:column;}}
</style>
</head>
<body>
<nav>
  <div class="logo"><span class="wave" aria-hidden="true">üåä</span>Water Health Index</div>
  <div class="nav-links">
    <a href="index.html">Home</a><a href="measure.html" class="active">Measure</a><a href="map.html">Map</a>
    <a href="farmers.html">Farmers Assistance</a><a href="care.html">Care</a><a href="chart.html">Chart</a><a href="details.html">Details</a>
    <span class="langbar">
      <select id="langsel">
        <option value="en">English</option><option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option><option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
        <option value="es">Espa√±ol</option><option value="fr">Fran√ßais</option><option value="ru">–†—É—Å—Å–∫–∏–π</option>
        <option value="ja">Êó•Êú¨Ë™û</option><option value="zh">‰∏≠Êñá</option>
      </select>
    </span>
  </div>
</nav>

<main>
  <h1 id="pageTitle">Measure Water Quality</h1>
  <div class="layout">
    <div class="left">
      <div class="card">
        <label id="lblPh" for="ph">pH (0.0 - 14.0)</label>
        <input id="ph" type="number" min="0" max="14" step="0.01" placeholder="7.00"/>
        <label id="lblTemp" for="temp">Temperature (¬∞C)</label>
        <input id="temp" type="number" min="-10" max="70" step="0.1" placeholder="25"/>
        <label id="lblTurb" for="turbidity">Turbidity</label>
        <select id="turbidity">
          <option value="" disabled selected>Select turbidity</option>
          <option value="Low">Low ‚Äî water looks clear; bottom and small objects are easy to see.</option>
          <option value="Medium">Medium ‚Äî water is slightly cloudy; shapes visible but details blurred.</option>
          <option value="High">High ‚Äî water is cloudy or muddy; hard to see more than a few cm deep.</option>
        </select>
        <div class="small-hint" id="turbHint">Low = clear water, Medium = slightly cloudy, High = cloudy or muddy water.</div>

        <div class="buttons-row">
          <button type="button" id="btnCamera" class="btn-main">Camera</button>
          <button type="button" id="btnSwitch" class="btn-main">Switch Camera</button>
          <button type="button" id="btnLocation" class="btn-main">Use My Location</button>
        </div>

        <div class="cam-card">
          <div class="cam-title" id="camTitle">Camera pH Reader</div>
          <div class="cam-box">
            <video id="cameraView" autoplay playsinline muted></video>
            <canvas id="phCanvas"></canvas>
            <div class="cam-overlay" id="camOverlay"></div>
          </div>
          <div class="buttons-row cam-buttons">
            <button type="button" id="btnDetect" class="btn-main">Capture Color</button>
            <button type="button" id="btnCloseCam" class="btn-danger">Close Camera</button>
          </div>
          <div class="cam-info" id="camInfo">Align the pH strip inside the dashed box under good light.</div>
        </div>

        <!-- New location pill card -->
        <div class="loc-card" id="locCard" style="display:none;">
          <div class="loc-pin">üìç</div>
          <div>
            <div class="loc-text" id="locationMain">‚Äî</div>
            <div class="loc-sub" id="locationSub">Your current test location</div>
          </div>
        </div>

        <div class="buttons-row">
          <button type="button" id="btnAnalyze" class="btn-main">Analyze</button>
          <button type="button" id="btnSave" class="btn-main">Save Reading</button>
          <button type="button" id="btnClear" class="btn-danger">Clear History</button>
        </div>

        <div class="status-card" id="statusCard">
          <div class="status-circle" id="statusScore">--</div>
          <div class="status-details">
            <div><strong id="statusLabel">Status</strong><span class="status-badge" id="statusBadge">--</span></div>
            <div class="status-sub">pH: <span id="sPh"></span> ‚Ä¢ Temp: <span id="sTemp"></span> ‚Ä¢ Turbidity: <span id="sTurb"></span></div>
            <div class="status-desc" id="statusText"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <div id="map"></div>
        <div class="map-caption" id="mapCaption">Your saved readings appear here. Green = Good, Yellow = Moderate, Red = Poor.</div>
      </div>
    </div>
  </div>

  <div class="history-title" id="histTitle">Saved Readings</div>
  <table>
    <thead><tr><th id="thWhen">When</th><th id="thPh">pH</th><th id="thTemp">Temp</th><th id="thTurb">Turb</th><th id="thIndex">Index</th></tr></thead>
    <tbody id="historyBody"><tr><td colspan="5" style="color:#7ba9b0;">No readings saved.</td></tr></tbody>
  </table>
</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const historyBody  = document.getElementById('historyBody');
  const statusCard   = document.getElementById('statusCard');
  const statusScore  = document.getElementById('statusScore');
  const statusText   = document.getElementById('statusText');
  const statusBadge  = document.getElementById('statusBadge');
  const sPh          = document.getElementById('sPh');
  const sTemp        = document.getElementById('sTemp');
  const sTurb        = document.getElementById('sTurb');
  const langSelect   = document.getElementById('langsel');
  const camInfo      = document.getElementById('camInfo');
  const turbHint     = document.getElementById('turbHint');
  const locCard      = document.getElementById('locCard');
  const locationMain = document.getElementById('locationMain');

  const strings = {
    en:{title:"Measure Water Quality",ph:"pH (0.0 - 14.0)",temp:"Temperature (¬∞C)",turb:"Turbidity",
        turbHint:"Low = clear water, Medium = slightly cloudy, High = cloudy or muddy water.",
        camera:"Camera",switchCam:"Switch Camera",capture:"Capture Color",closeCam:"Close Camera",
        location:"Use My Location",analyze:"Analyze",save:"Save Reading",clear:"Clear History",
        histTitle:"Saved Readings",noReadings:"No readings saved.",
        mapCap:"Your saved readings appear here. Green = Good, Yellow = Moderate, Red = Poor.",
        status:"Status",camTitle:"Camera pH Reader",camInfo:"Align the pH strip inside the dashed box under good light.",
        thWhen:"When",thPh:"pH",thTemp:"Temp",thTurb:"Turb",thIndex:"Index"}
  };

  let lang = localStorage.getItem('whilang') || 'en';
  langSelect.value = lang;

  function applyLang(){
    const t = strings[lang] || strings.en;
    document.getElementById('pageTitle').textContent = t.title;
    document.getElementById('lblPh').textContent     = t.ph;
    document.getElementById('lblTemp').textContent   = t.temp;
    document.getElementById('lblTurb').textContent   = t.turb;
    turbHint.textContent                             = t.turbHint;
    document.getElementById('btnCamera').textContent = t.camera;
    document.getElementById('btnSwitch').textContent = t.switchCam;
    document.getElementById('btnDetect').textContent = t.capture;
    document.getElementById('btnCloseCam').textContent = t.closeCam;
    document.getElementById('btnLocation').textContent = t.location;
    document.getElementById('btnAnalyze').textContent = t.analyze;
    document.getElementById('btnSave').textContent   = t.save;
    document.getElementById('btnClear').textContent  = t.clear;
    document.getElementById('histTitle').textContent = t.histTitle;
    document.getElementById('mapCaption').textContent = t.mapCap;
    document.getElementById('statusLabel').textContent = t.status;
    document.getElementById('camTitle').textContent = t.camTitle;
    camInfo.textContent = t.camInfo;
    document.getElementById('thWhen').textContent  = t.thWhen;
    document.getElementById('thPh').textContent    = t.thPh;
    document.getElementById('thTemp').textContent  = t.thTemp;
    document.getElementById('thTurb').textContent  = t.thTurb;
    document.getElementById('thIndex').textContent = t.thIndex;

    const hist = JSON.parse(localStorage.getItem('whReadings') || '[]');
    if (!hist.length) {
      historyBody.innerHTML = `<tr><td colspan="5" style="color:#7ba9b0;">${t.noReadings}</td></tr>`;
    }
  }
  langSelect.addEventListener('change', () => { lang = langSelect.value; localStorage.setItem('whilang', lang); applyLang(); });
  applyLang();

  // Map + place name
  const map = L.map('map', {zoomControl:true, scrollWheelZoom:false}).setView([23,80], 4.5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:13,attribution:'¬© OpenStreetMap'}).addTo(map);
  let marker = null;
  async function reverseGeocode(lat,lng){
    try{
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
      const res = await fetch(url); const data = await res.json();
      return data.display_name || `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
    }catch{ return `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`; }
  }
  document.getElementById('btnLocation').addEventListener('click', () => {
    if (!navigator.geolocation) { alert("Geolocation not supported by this browser."); return; }
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      const label = await reverseGeocode(lat,lng);
      locationMain.textContent = label;
      locCard.style.display = 'flex';
      if (!marker) marker = L.marker([lat,lng]).addTo(map); else marker.setLatLng([lat,lng]);
      map.setView([lat,lng], 12);
    }, () => alert("Could not get location."));
  });

  // Camera + improved capture (camera stays open)
  const video  = document.getElementById('cameraView');
  const canvas = document.getElementById('phCanvas');
  let ctx = canvas.getContext ? canvas.getContext('2d') : null;
  let stream = null, facing = 'environment';

  async function openCamera(){
    try{
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert("Camera API not supported in this browser."); return; }
      if (stream) return;
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:facing}});
      video.srcObject = stream; video.style.display = 'block'; canvas.style.display='none'; video.play();
    }catch(e){ alert("Camera not available or permission denied."); }
  }
  function closeCamera(){ if (stream){stream.getTracks().forEach(t=>t.stop());stream=null;} video.style.display='none'; canvas.style.display='none'; }
  document.getElementById('btnCamera').addEventListener('click', openCamera);
  document.getElementById('btnCloseCam').addEventListener('click', closeCamera);
  document.getElementById('btnSwitch').addEventListener('click', () => { facing = (facing === 'environment') ? 'user' : 'environment'; closeCamera(); openCamera(); });

  function rgbToPh(r,g,b){
    let ph; if (r>g && r>b) ph = 3 + (14-3)*(255-r)/255; else if (b>r && b>g) ph = 8 + (14-8)*b/255; else ph = 6 + (8-6)*g/255;
    return Math.max(0,Math.min(14,ph));
  }
  function captureColor(){
    if (!ctx){ alert("Canvas not available."); return; }
    if (!video.videoWidth){ alert("Open the camera and wait, then try again."); return; }
    const w = video.videoWidth, h = video.videoHeight;
    canvas.width = w; canvas.height = h; ctx.drawImage(video,0,0,w,h);
    const box = 20, sx = Math.max(0, Math.floor(w/2 - box/2)), sy = Math.max(0, Math.floor(h/2 - box/2));
    const img = ctx.getImageData(sx, sy, box, box), data = img.data;
    let r=0,g=0,b=0; const px = data.length/4;
    for(let i=0;i<data.length;i+=4){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; }
    r/=px; g/=px; b/=px;
    const ph = rgbToPh(r,g,b);
    document.getElementById('ph').value = ph.toFixed(2);
    camInfo.textContent = `Captured color (avg): R${r.toFixed(0)} G${g.toFixed(0)} B${b.toFixed(0)} ‚Üí pH ‚âà ${ph.toFixed(2)}`;
    // stay open
    canvas.style.display='none'; video.style.display='block';
  }
  document.getElementById('btnDetect').addEventListener('click', captureColor);

  // Index + status (30)
  function calcIndex(ph,temp,turb){
    let score = 100; score -= Math.abs(7-ph)*8; score -= (40-temp)*0.9; if (turb==="High") score-=18; else if (turb==="Medium") score-=6;
    return Math.round(Math.max(0,Math.min(100,score)));
  }
  const thresholds=[100,97,94,91,88,85,82,79,76,73,70,67,64,61,58,55,52,49,46,43,40,37,34,31,28,25,22,19,15,0];
  const messages=[
    "Perfect lab-grade water.","Ultra‚Äëclean, ideal for sensitive crops and drinking.","Pristine mountain‚Äëspring quality.",
    "Excellent ‚Äî minimal stress.","Very good quality, safe for drinking.","Good quality, only minor treatment needed.",
    "Slightly imbalanced but generally safe.","Fair quality ‚Äî simple filtration recommended.","Usable, but avoid for babies or sensitive users.",
    "Noticeable issues; treat before drinking.","Moderate quality, not ideal for daily drinking.","Stressed water; boil and filter strongly.",
    "Borderline safe ‚Äî use only with treatment.","Poor quality; not recommended for direct use.","Very poor; use only for cleaning, not drinking.",
    "High pollution risk; avoid for animals too.","Severely stressed ecosystem water.","Strong contamination suspected.",
    "Dangerous for human consumption.","Extremely poor; emergency use only.","Unsuitable for irrigation without strong treatment.",
    "Toxic risk; may harm crops and fish.","Very high contamination, keep away.","Industrial‚Äëlevel pollution likely.",
    "Critical ‚Äî do not use for any living beings.","Hazardous chemical signature.","Near‚Äëtoxic concentrate; isolate source.",
    "Emergency contamination zone.","Deadly quality ‚Äî immediate action required.","Unusable water ‚Äî treat as hazardous waste."
  ];
  function classify(score){ if(score>=90)return "EXCELLENT"; if(score>=75)return "GOOD"; if(score>=60)return "FAIR"; if(score>=45)return "POOR"; return "VERY POOR"; }
  function analyze(){
    const ph=parseFloat(document.getElementById('ph').value), temp=parseFloat(document.getElementById('temp').value), turb=document.getElementById('turbidity').value;
    if(isNaN(ph)||isNaN(temp)||!turb){ alert("Please enter pH, temperature, and select turbidity."); return null; }
    const idx=calcIndex(ph,temp,turb); statusScore.textContent=idx; const badge=classify(idx); statusBadge.textContent=badge;
    if(badge==="EXCELLENT")statusBadge.style.background="#1c6b3f"; else if(badge==="GOOD")statusBadge.style.background="#2c9b5a";
    else if(badge==="FAIR")statusBadge.style.background="#d0a000"; else if(badge==="POOR")statusBadge.style.background="#c45a2f"; else statusBadge.style.background="#b02030";
    let msg=messages[messages.length-1]; for(let i=0;i<thresholds.length;i++){ if(idx>=thresholds[i]){ msg=messages[i]; break; } }
    statusText.textContent=msg; sPh.textContent=ph.toFixed(2); sTemp.textContent=temp.toFixed(1)+"¬∞C"; sTurb.textContent=turb; statusCard.style.display="flex";
    return {ph,temp,turb,index:idx};
  }
  document.getElementById('btnAnalyze').addEventListener('click', analyze);

  // History
  function renderHistory(){ const t=strings[lang]||strings.en; const hist=JSON.parse(localStorage.getItem('whReadings')||'[]');
    historyBody.innerHTML=""; if(!hist.length){ historyBody.innerHTML=`<tr><td colspan="5" style="color:#7ba9b0;">${t.noReadings}</td></tr>`; return; }
    hist.slice().reverse().forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.when}</td><td>${r.ph}</td><td>${r.temp}</td><td>${r.turb}</td><td>${r.index}</td>`; historyBody.appendChild(tr); });
  }
  function saveReading(){ const result=analyze(); if(!result) return; const hist=JSON.parse(localStorage.getItem('whReadings')||'[]');
    hist.push({when:new Date().toLocaleString(),ph:result.ph.toFixed(2),temp:result.temp.toFixed(1),turb:result.turb,index:result.index});
    localStorage.setItem('whReadings',JSON.stringify(hist)); renderHistory();
  }
  document.getElementById('btnSave').addEventListener('click', saveReading);
  document.getElementById('btnClear').addEventListener('click',()=>{ if(confirm("Clear all saved readings?")){ localStorage.removeItem('whReadings'); renderHistory(); }});
  renderHistory();
});
</script>
</body>
</html>
