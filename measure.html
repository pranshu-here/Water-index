<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Water Health Index – Measure</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
/* ... (keep all previous CSS as in last version, unchanged) ... */
</style>
</head>
<body>
<nav>
  <!-- Navigation unchanged -->
  <!-- ... -->
</nav>
<main>
  <!-- All form, map, and table HTML unchanged -->
  <!-- ... -->
</main>
<!-- Video, Canvas, and Leaflet JS like before ... -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
// All code runs after DOM is fully loaded
// Translation, setup code...
// Place all JS functions, event listeners, and logic here EXPLICITLY
// (Copy the last working JS, but change onload, and move every onclick assignment inside this handler)
// Also, ensure the map is initialized AFTER the #mini-map element exists and has CSS height

// Example structure (repeat for all event handlers):
const translations = { /* ... insert EN/HI translations ... */ };
function _(k){return translations[window.lang][k]||translations.en[k]||k;}
window.lang = localStorage.getItem('whilang')||'en';
document.getElementById('langsel').value=window.lang;
document.getElementById('langsel').addEventListener('change',e=>{
  window.lang = e.target.value; localStorage.setItem('whilang',window.lang); transUI();
});
function transUI(){
  document.getElementById('main-title').innerHTML = _( 'mainTitle' );
  document.getElementById('lbl-ph').innerHTML = _( 'lblPh' );
  document.getElementById('lbl-temp').innerHTML = _( 'lblTemp' );
  document.getElementById('lbl-turb').innerHTML = _( 'lblTurb' );
  document.getElementById('cameraBtn').innerHTML = _( 'camera' );
  document.getElementById('switchCamBtn').innerHTML = _( 'switchCam' );
  document.getElementById('detPhBtn').innerHTML = _( 'detPh' );
  document.getElementById('locBtn').innerHTML = _( 'geo' );
  document.getElementById('analyzeBtn').innerHTML = _( 'analyze' );
  document.getElementById('clearReadingsBtn').innerHTML = _( 'clear' );
  document.getElementById('history-title').innerHTML = _( 'histTitle' );
  document.getElementById('mapLegend').innerHTML = _( 'legend' );
}
transUI();

// --- MAP ---
let map, marker;
function initMap(){
  const mapEl = document.getElementById('mini-map');
  mapEl.style.height = '320px'; // ensure fixed height before Leaflet runs
  map = L.map('mini-map',{zoomControl:true,scrollWheelZoom:false}).setView([23,86], 4.7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:13,attribution:'&copy; OpenStreetMap'}).addTo(map);
}
initMap();

// --- GEO ---
async function geocodeLatLng(lat,lng){
  let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
  let data = await res.json(); return data.display_name || "Unknown Location";
}
document.getElementById('locBtn').onclick=()=>{
  if(!navigator.geolocation){alert("Geolocation not supported.");return;}
  navigator.geolocation.getCurrentPosition(async pos=>{
    let lat=pos.coords.latitude,lng=pos.coords.longitude,addr=await geocodeLatLng(lat,lng);
    document.getElementById('locationInfo').innerText = addr;
    if(!marker){ marker = L.marker([lat,lng]).addTo(map);}
    else{ marker.setLatLng([lat,lng]); }
    map.setView([lat,lng],12);
  },()=>alert("Unable to retrieve location."));
};

// --- Camera & Detect pH ---
let camStream=null, currentCam="environment";
const video=document.getElementById('cameraView'), canvas=document.getElementById('phCanvas'), ctx=canvas.getContext('2d');
document.getElementById('cameraBtn').onclick = async function() {
  canvas.style.display='none';
  if(camStream){ camStream.getTracks().forEach(t=>t.stop());camStream=null;video.style.display='none';return;}
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:currentCam}});
    video.srcObject=camStream; video.style.display='block'; video.play();
  }catch{ alert("Cannot open camera."); }
};
document.getElementById('switchCamBtn').onclick=function(){
  currentCam=(currentCam==="environment")?"user":"environment";
  if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null;video.style.display='none';}
};
document.getElementById('detPhBtn').onclick=function(){
  if(!video.srcObject){alert("Open camera first.");return;}
  let vw=video.videoWidth||320, vh=video.videoHeight||240;
  canvas.width=vw; canvas.height=vh;
  ctx.drawImage(video,0,0,vw,vh);
  canvas.style.display='block';
  video.style.display='none';
  camStream&&camStream.getTracks().forEach(t=>t.stop());camStream=null;
  canvas.onclick=function(e){
    let rect = canvas.getBoundingClientRect();
    let x = Math.floor((e.clientX-rect.left)*canvas.width/rect.width);
    let y = Math.floor((e.clientY-rect.top)*canvas.height/rect.height);
    let rgb=ctx.getImageData(x,y,1,1).data;
    let [r,g,b]=rgb,hue=Math.atan2(Math.sqrt(3)*(g-b),2*r-g-b)*180/Math.PI;
    hue = (hue+360)%360;
    let ph = Math.round( ((hue-60)/200)*7 + 7 );
    ph = Math.max(0,Math.min(14,ph||7));
    document.getElementById('ph').value=ph;
    alert("Color read: ("+r+","+g+","+b+")\nDemo pH: "+ph);
    canvas.style.display='none';
    video.style.display='none';
  };
};

// --- Analyze, Save, and Table ---
function calcIndex(ph,temp,turb){return Math.max(0,Math.min(100,Math.round(100-Math.abs(7-ph)*8-(40-temp)*.9-(turb==="High"?18:(turb==="Medium"?6:0)))));}
function analyzeReading(){
  let ph=parseFloat(document.getElementById('ph').value);
  let temp=parseFloat(document.getElementById('temp').value);
  let tur=document.getElementById('turbidity').value;
  if(isNaN(ph)||isNaN(temp)||!tur){alert("Fill all fields!");return;}
  let index=calcIndex(ph,temp,tur),desc="",ranges=_( 'statusRanges' ),msgs=_( 'statusDescs' );
  for(let i=0;i<ranges.length;i++){if(index<=ranges[i]){desc=msgs[i];break;}}
  let score=document.getElementById('statusScore'),msg=document.getElementById('statusMsg'),tag=document.getElementById('statusText'),card=document.getElementById('statusCard'),phEl=document.getElementById('statusPh'),tempEl=document.getElementById('statusTemp'),turbEl=document.getElementById('statusTurb'),taglab=document.getElementById('statusTag');
  score.innerHTML=index; msg.innerHTML=desc; tag.innerHTML=desc?desc.split(":")[0]:"";
  phEl.innerHTML=ph; tempEl.innerHTML=temp+"°C"; turbEl.innerHTML=tur;
  card.className="status-card"; if(index>=80)card.classList.add("status-good"); else if(index>=60)card.classList.add("status-mod"); else card.classList.add("status-bad");
  taglab.innerHTML=_( 'statusTag' ); card.hidden=false;
  saveReading(ph,temp,tur,index);
}
document.getElementById('analyzeBtn').onclick=analyzeReading;
function saveReading(ph,temp,tur,index){
  let now=new Date().toLocaleString(),history=JSON.parse(localStorage.getItem('waterHistory')||'[]');
  history.push({when:now,ph,temp,turbidity:tur,index});localStorage.setItem('waterHistory',JSON.stringify(history));renderHistory();
}
document.getElementById('clearReadingsBtn').onclick=function(){if(confirm("Clear all saved readings?")){localStorage.removeItem('waterHistory');renderHistory();}};
function renderHistory(){
  let tbody=document.getElementById('historyBody'),h=JSON.parse(localStorage.getItem('waterHistory')||'[]');
  tbody.innerHTML=h.length?"" : `<tr><td colspan="5">${_( 'noReadings')}</td></tr>`;
  h.slice().reverse().forEach(r=>{
    let row=document.createElement('tr');
    row.innerHTML=`<td>${r.when}</td><td>${r.ph}</td><td>${r.temp}</td><td>${r.turbidity}</td><td>${r.index}</td>`;tbody.appendChild(row);
  });
}
});
</script>
</body>
</html>
